<!-- 85c9275a-5d3e-44cb-a9c6-a2eb2f7c293b 1032118a-da7a-46a3-bb61-2f68900eb721 -->
# 手机号登录功能开发计划

## 1. 更新Prisma Schema数据库模型

**文件**: `prisma/schema.prisma`

修改User模型，调整唯一约束策略：

- 移除`openid`的`@unique`约束
- 移除`email`和`phone`的`@unique`约束
- 添加组合唯一索引：`@@unique([phone, openid])`和`@@unique([email, openid])`
- 确保同一手机号/邮箱可以配合不同的openid创建多个账号
```prisma
model User {
  id       String   @id @default(uuid())
  openid   String?  // 移除@unique
  email    String?  // 移除@unique
  phone    String?  // 移除@unique
  // ... 其他字段
  
  @@unique([phone, openid])
  @@unique([email, openid])
  @@map("users")
}
```


## 2. 创建手机号登录相关DTO

**文件**: `src/modules/auth/dto/phone-login.dto.ts` (新建)

创建以下DTO类：

- `CheckPhoneDto`: 检查手机号是否存在
- `OneClickLoginDto`: 一键登录（移动商SDK获取）
- `PhoneCodeLoginDto`: 验证码登录
- `SendSmsCodeDto`: 发送验证码
```typescript
export class CheckPhoneDto {
  @IsNotEmpty()
  @IsPhoneNumber('CN')
  phone: string;
}

export class OneClickLoginDto {
  @IsNotEmpty()
  phone: string;
  
  @IsNotEmpty()
  accessToken: string; // 移动商SDK返回的token
}

export class PhoneCodeLoginDto {
  @IsNotEmpty()
  phone: string;
  
  @IsNotEmpty()
  code: string; // 验证码
}
```


## 3. 创建短信验证服务

**文件**: `src/modules/auth/sms.service.ts` (新建)

实现短信验证码功能：

- 发送验证码（集成阿里云/腾讯云短信服务）
- 验证验证码（使用Redis存储，5分钟过期）
- 限制发送频率（60秒内只能发送一次）
```typescript
@Injectable()
export class SmsService {
  async sendCode(phone: string): Promise<boolean>
  async verifyCode(phone: string, code: string): Promise<boolean>
}
```


## 4. 扩展UserService

**文件**: `src/modules/user/user.service.ts`

添加新的查询方法：

- `getUserByPhone(phone: string)`: 通过手机号查询用户
- `getUserByPhoneAndOpenid(phone: string, openid: string)`: 通过手机号和openid组合查询
- `createPhoneUser(data)`: 创建手机号用户
```typescript
async getUserByPhone(phone: string): Promise<User | null> {
  return await this.prisma.user.findFirst({
    where: { phone }
  });
}

async getUserByPhoneAndOpenid(phone: string, openid: string): Promise<User | null> {
  return await this.prisma.user.findUnique({
    where: { 
      phone_openid: { phone, openid }
    }
  });
}
```


## 5. 扩展AuthService

**文件**: `src/modules/auth/auth.service.ts`

添加手机号登录相关方法：

- `checkPhone(phone: string)`: 检查手机号是否已注册
- `oneClickLogin(dto: OneClickLoginDto)`: 一键登录
- `phoneCodeLogin(dto: PhoneCodeLoginDto)`: 验证码登录
- `updateRefreshTokenExpiry()`: 调整refresh token过期时间
```typescript
async checkPhone(phone: string) {
  const user = await this.userService.getUserByPhone(phone);
  return {
    exists: !!user,
    userId: user?.id
  };
}

async oneClickLogin(dto: OneClickLoginDto) {
  // 1. 验证移动商SDK token
  // 2. 查询或创建用户
  // 3. 返回JWT tokens
}

async phoneCodeLogin(dto: PhoneCodeLoginDto) {
  // 1. 验证短信验证码
  // 2. 查询或创建用户
  // 3. 返回JWT tokens
}
```


调整JWT过期时间：

- Access Token: 30天
- Refresh Token: 60天

## 6. 添加Controller端点

**文件**: `src/modules/auth/auth.controller.ts`

添加以下API端点：

- `POST /auth/check-phone`: 检查手机号
- `POST /auth/phone/one-click`: 一键登录
- `POST /auth/phone/code-login`: 验证码登录
- `POST /auth/phone/send-code`: 发送验证码
```typescript
@Public()
@Post('/check-phone')
async checkPhone(@Body() dto: CheckPhoneDto) {
  return await this.authService.checkPhone(dto.phone);
}

@Public()
@Post('/phone/one-click')
async oneClickLogin(@Body() dto: OneClickLoginDto) {
  return await this.authService.oneClickLogin(dto);
}

@Public()
@Post('/phone/code-login')
async phoneCodeLogin(@Body() dto: PhoneCodeLoginDto) {
  return await this.authService.phoneCodeLogin(dto);
}
```


## 7. 更新AuthModule

**文件**: `src/modules/auth/auth.module.ts`

添加新的Provider：

- SmsService

可选：添加Redis模块用于验证码存储

## 8. 数据库迁移

运行Prisma迁移命令：

```bash
npx prisma migrate dev --name add-phone-login
npx prisma generate
```

## 9. 环境变量配置

**文件**: `.env`

添加短信服务配置：

```env
SMS_ACCESS_KEY=xxx
SMS_SECRET_KEY=xxx
SMS_SIGN_NAME=xxx
SMS_TEMPLATE_CODE=xxx
```

## 技术要点

1. 用户唯一性：使用`(phone, openid)`组合唯一索引
2. 自动注册：检查不存在时自动创建用户
3. JWT配置：Access Token 30天，Refresh Token 60天
4. 返回数据：包含用户信息 + accessToken + refreshToken
5. 短信验证：验证码5分钟有效，60秒限制重发