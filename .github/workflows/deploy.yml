name: Deploy to Aliyun

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
on:
  push:
    branches:
      - main
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# ç¯å¢ƒå˜é‡ï¼ˆå¯åœ¨ GitHub Secrets ä¸­è¦†ç›–ï¼‰
env:
  # æœåŠ¡å™¨ SSH é…ç½®
  # éœ€è¦åœ¨ GitHub Secrets ä¸­é…ç½®ï¼š
  # SERVER_HOST: é˜¿é‡Œäº‘æœåŠ¡å™¨å…¬ç½‘ IP æˆ–åŸŸåï¼Œä¾‹å¦‚ï¼š123.456.789.0 æˆ– api.example.com
  # SERVER_SSH_KEY: SSH ç§é’¥å†…å®¹ï¼ˆå®Œæ•´å†…å®¹ï¼ŒåŒ…æ‹¬ -----BEGIN RSA PRIVATE KEY----- å’Œ -----END RSA PRIVATE KEY-----ï¼‰
  # SERVER_USER: SSH ç™»å½•ç”¨æˆ·åï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º rootï¼‰
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
  SERVER_USER: ${{ secrets.SERVER_USER || 'root' }}
  
  # æœåŠ¡å™¨éƒ¨ç½²è·¯å¾„ï¼ˆå¯åœ¨ GitHub Secrets ä¸­è¦†ç›–ï¼Œé»˜è®¤ä¸º /opt/claw_step_serveï¼‰
  SERVER_DEPLOY_PATH: ${{ secrets.SERVER_DEPLOY_PATH || '/opt/claw_step_serve' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create deployment package
        run: |
          # åˆ›å»ºéƒ¨ç½²åŒ…ï¼Œæ’é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          # æ³¨æ„ï¼š.env å’Œ .env.production ä¼šè¢«åŒ…å«ï¼ˆç§æœ‰ä»“åº“å…è®¸æäº¤ï¼‰
          echo "ğŸ“¦ æ‰“åŒ…ä»£ç ..."
          zip -r deploy.zip . \
            -x "*.git*" \
            -x "*node_modules*" \
            -x ".env.local" \
            -x ".env.development" \
            -x ".env.development.local" \
            -x ".env.test" \
            -x ".env.test.local" \
            -x "*dist*" \
            -x "*.log" \
            -x "*coverage*" \
            -x "*.DS_Store" \
            -x "*test*" \
            -x "*.vscode*" \
            -x "*.idea*" \
            -x "*__pycache__*" \
            -x "*.pytest_cache*"
          
          # æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f ".env.production" ]; then
            echo "âœ… .env.production å·²åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­"
          else
            echo "âš ï¸  è­¦å‘Š: .env.production ä¸å­˜åœ¨"
          fi
          
          if [ -f ".env" ]; then
            echo "âœ… .env å·²åŒ…å«åœ¨éƒ¨ç½²åŒ…ä¸­"
          fi
          
          echo "âœ… æ‰“åŒ…å®Œæˆï¼Œæ–‡ä»¶å¤§å°ï¼š"
          ls -lh deploy.zip
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SERVER_SSH_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts
          echo "âœ… å·²æ·»åŠ æœåŠ¡å™¨åˆ° known_hosts"
      
      - name: Debug SSH configuration
        run: |
          echo "ğŸ” è°ƒè¯• SSH é…ç½®..."
          echo "SSH_AUTH_SOCK: $SSH_AUTH_SOCK"
          echo "æœåŠ¡å™¨ç”¨æˆ·: ${{ env.SERVER_USER }}"
          echo "æœåŠ¡å™¨åœ°å€: ${{ env.SERVER_HOST }}"
          echo ""
          echo "å·²åŠ è½½çš„ SSH å¯†é’¥:"
          ssh-add -l || echo "âš ï¸  æ— æ³•åˆ—å‡º SSH å¯†é’¥"
          echo ""
          echo "æµ‹è¯• SSH è¿æ¥..."
      
      - name: Test SSH connection
        run: |
          ssh -v -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=10 \
              ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} \
              "echo 'âœ… SSH è¿æ¥æˆåŠŸ' && whoami && pwd" || {
            echo "âŒ SSH è¿æ¥å¤±è´¥"
            echo "è¯·æ£€æŸ¥ï¼š"
            echo "1. SERVER_HOST æ˜¯å¦æ­£ç¡®"
            echo "2. SERVER_USER æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤ rootï¼‰"
            echo "3. SERVER_SSH_KEY æ˜¯å¦æ­£ç¡®é…ç½®"
            echo "4. æœåŠ¡å™¨ä¸Šçš„ authorized_keys æ˜¯å¦åŒ…å«å¯¹åº”çš„å…¬é’¥"
            exit 1
          }
      
      - name: Upload and deploy to server
        run: |
          # ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
          echo "ğŸ“¤ ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨..."
          scp -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=30 \
              -o LogLevel=ERROR \
              deploy.zip ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/deploy.zip
          
          # åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²
          ssh -o StrictHostKeyChecking=no \
              -o UserKnownHostsFile=~/.ssh/known_hosts \
              -o ConnectTimeout=30 \
              -o LogLevel=ERROR \
              -T \
              ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << EOF
            set -e
            
            # æ£€æŸ¥å¹¶å®‰è£… Docker å’Œ Docker Compose
            echo "ğŸ” æ£€æŸ¥ Docker ç¯å¢ƒ..."
            
            # æ£€æŸ¥ Docker
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ å®‰è£… Docker..."
              
              # æ£€æµ‹ç³»ç»Ÿç±»å‹
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                OS=\$ID
              else
                OS="unknown"
              fi
              
              # é’ˆå¯¹é˜¿é‡Œäº‘ Linux (alinux) ä½¿ç”¨ yum å®‰è£…
              if [ "\$OS" = "alinux" ] || grep -q "Alibaba Cloud Linux" /etc/os-release 2>/dev/null; then
                echo "   æ£€æµ‹åˆ°é˜¿é‡Œäº‘ Linuxï¼Œä½¿ç”¨ yum å®‰è£… Docker (ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº)..."
                # å®‰è£…å¿…è¦çš„å·¥å…·
                yum install -y yum-utils device-mapper-persistent-data lvm2
                # æ·»åŠ  Docker ä»“åº“ (ä½¿ç”¨ http åè®®çš„é˜¿é‡Œäº‘é•œåƒæºï¼Œé¿å… SSL é—®é¢˜)
                yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
                # ç¡®ä¿ repo æ–‡ä»¶ä¸­ä¹Ÿæ˜¯ http
                sed -i 's+https://mirrors.aliyun.com+http://mirrors.aliyun.com+g' /etc/yum.repos.d/docker-ce.repo
                sed -i 's+https://download.docker.com+http://mirrors.aliyun.com/docker-ce+g' /etc/yum.repos.d/docker-ce.repo
                
                # å®‰è£… Docker
                yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                systemctl start docker
                systemctl enable docker
                echo "âœ… Docker å®‰è£…å®Œæˆ"
              elif command -v yum &> /dev/null; then
                echo "   ä½¿ç”¨ yum å®‰è£… Docker (ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº)..."
                yum install -y yum-utils device-mapper-persistent-data lvm2
                # æ·»åŠ  Docker ä»“åº“ (ä½¿ç”¨ http åè®®çš„é˜¿é‡Œäº‘é•œåƒæº)
                yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
                # ç¡®ä¿ repo æ–‡ä»¶ä¸­ä¹Ÿæ˜¯ http
                sed -i 's+https://mirrors.aliyun.com+http://mirrors.aliyun.com+g' /etc/yum.repos.d/docker-ce.repo
                sed -i 's+https://download.docker.com+http://mirrors.aliyun.com/docker-ce+g' /etc/yum.repos.d/docker-ce.repo
                
                yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                systemctl start docker
                systemctl enable docker
                echo "âœ… Docker å®‰è£…å®Œæˆ"
              elif command -v apt-get &> /dev/null; then
                echo "   ä½¿ç”¨ apt-get å®‰è£… Docker..."
                apt-get update
                apt-get install -y ca-certificates curl gnupg lsb-release
                mkdir -p /etc/apt/keyrings
                curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                echo "deb [arch=\$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \$(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
                apt-get update
                apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
                systemctl start docker
                systemctl enable docker
                echo "âœ… Docker å®‰è£…å®Œæˆ"
              else
                echo "   å°è¯•ä½¿ç”¨å®˜æ–¹å®‰è£…è„šæœ¬..."
                curl -fsSL https://get.docker.com | bash || {
                  echo "âŒ Docker å®‰è£…å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
                  exit 1
                }
                systemctl start docker
                systemctl enable docker
                echo "âœ… Docker å®‰è£…å®Œæˆ"
              fi
            else
              echo "âœ… Docker å·²å®‰è£…: \$(docker --version)"
            fi
            
            # æ£€æŸ¥ Docker Compose
            if ! command -v docker-compose &> /dev/null; then
              echo "ğŸ“¦ å®‰è£… Docker Compose..."
              DOCKER_COMPOSE_VERSION=\$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\\" -f4)
              curl -L "https://github.com/docker/compose/releases/download/\${DOCKER_COMPOSE_VERSION}/docker-compose-\$(uname -s)-\$(uname -m)" -o /usr/local/bin/docker-compose
              chmod +x /usr/local/bin/docker-compose
              echo "âœ… Docker Compose å®‰è£…å®Œæˆ"
            else
              echo "âœ… Docker Compose å·²å®‰è£…: \$(docker-compose --version)"
            fi
            
            # æ£€æŸ¥ unzipï¼ˆç”¨äºè§£å‹éƒ¨ç½²åŒ…ï¼‰
            if ! command -v unzip &> /dev/null; then
              echo "ğŸ“¦ å®‰è£… unzip..."
              if command -v yum &> /dev/null; then
                yum install -y unzip
              elif command -v apt-get &> /dev/null; then
                apt-get update && apt-get install -y unzip
              else
                echo "âš ï¸  æ— æ³•è‡ªåŠ¨å®‰è£… unzipï¼Œè¯·æ‰‹åŠ¨å®‰è£…"
                exit 1
              fi
              echo "âœ… unzip å®‰è£…å®Œæˆ"
            else
              echo "âœ… unzip å·²å®‰è£…"
            fi
            
            # è®¾ç½®éƒ¨ç½²ç›®å½•
            DEPLOY_DIR="${{ env.SERVER_DEPLOY_PATH }}"
            
            # æ‰§è¡Œ server-setup.sh è„šæœ¬çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆè·³è¿‡ root æ£€æŸ¥å’Œæç¤ºä¿¡æ¯ï¼‰
            echo "ğŸš€ æ‰§è¡ŒæœåŠ¡å™¨åˆå§‹åŒ–..."
            
            # åˆ›å»ºé¡¹ç›®ç›®å½•å’Œå¿…è¦çš„ç›®å½•ç»“æ„
            echo "ğŸ“ åˆ›å»ºé¡¹ç›®ç›®å½•: \$DEPLOY_DIR"
            mkdir -p "\$DEPLOY_DIR"
            cd "\$DEPLOY_DIR"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æ„ï¼ˆnginx ç›¸å…³ç›®å½•ï¼‰
            echo "ğŸ“ åˆ›å»ºç›®å½•ç»“æ„..."
            mkdir -p nginx/conf.d
            mkdir -p nginx/ssl
            mkdir -p nginx/logs
            mkdir -p backups
            
            echo "âœ… æœåŠ¡å™¨ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
            
            # å¤‡ä»½å½“å‰ç‰ˆæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "current" ]; then
              echo "ğŸ’¾ å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
              BACKUP_DIR="backup_\$(date +%Y%m%d_%H%M%S)"
              mkdir -p backups
              mv current "backups/\$BACKUP_DIR" || true
            fi
            
            # åˆ›å»ºæ–°ç‰ˆæœ¬ç›®å½•
            mkdir -p current
            cd current
            
            # è§£å‹éƒ¨ç½²åŒ…
            echo "ğŸ“¥ è§£å‹éƒ¨ç½²åŒ…..."
            unzip -q /tmp/deploy.zip -d .
            rm /tmp/deploy.zip
            
            # æ£€æŸ¥ .env.production æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f ".env.production" ]; then
              echo "âš ï¸  éƒ¨ç½²åŒ…ä¸­æœªæ‰¾åˆ° .env.productionï¼Œå°è¯•ä»å¤‡ä»½æ¢å¤..."
              if [ -d "../backups" ] && [ -n "\$(ls -A ../backups 2>/dev/null)" ]; then
                LATEST_BACKUP=\$(ls -t ../backups | head -1)
                if [ -f "../backups/\$LATEST_BACKUP/.env.production" ]; then
                  cp "../backups/\$LATEST_BACKUP/.env.production" .env.production
                  echo "âœ… å·²ä»å¤‡ä»½æ¢å¤ .env.production"
                else
                  echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° .env.production æ–‡ä»¶"
                  echo "è¯·ç¡®ä¿ä»“åº“ä¸­åŒ…å« .env.production æ–‡ä»¶ï¼Œæˆ–é¦–æ¬¡éƒ¨ç½²æ—¶æ‰‹åŠ¨åˆ›å»º"
                  exit 1
                fi
              else
                echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° .env.production æ–‡ä»¶"
                echo "è¯·ç¡®ä¿ä»“åº“ä¸­åŒ…å« .env.production æ–‡ä»¶ï¼Œæˆ–é¦–æ¬¡éƒ¨ç½²æ—¶æ‰‹åŠ¨åˆ›å»º"
                exit 1
              fi
            else
              echo "âœ… æ‰¾åˆ° .env.production æ–‡ä»¶"
            fi
            
            # åœæ­¢ç°æœ‰æœåŠ¡ï¼ˆåœ¨ current ç›®å½•ä¸‹æ‰§è¡Œï¼‰
            echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
            docker-compose -f docker-compose.prod.yml down || true
            
            # æ„å»ºå¹¶å¯åŠ¨æ–°æœåŠ¡
            echo "ğŸ”¨ æ„å»º Docker é•œåƒ..."
            docker-compose -f docker-compose.prod.yml build --no-cache app
            
            echo "ğŸš€ å¯åŠ¨æ–°æœåŠ¡..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
            docker-compose -f docker-compose.prod.yml ps
            
            # è¿è¡Œæ•°æ®åº“è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
            echo "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
            docker-compose -f docker-compose.prod.yml exec -T app npx prisma migrate deploy || {
              echo "âš ï¸  æ•°æ®åº“è¿ç§»å¤±è´¥æˆ–ä¸éœ€è¦è¿ç§»"
            }
            
            # æ¸…ç†æ—§é•œåƒå’Œæœªä½¿ç”¨çš„èµ„æº
            echo "ğŸ§¹ æ¸…ç†æ—§é•œåƒ..."
            docker image prune -f
            
            # æ¸…ç†æ—§å¤‡ä»½ï¼ˆåªä¿ç•™æœ€è¿‘ 5 ä¸ªï¼‰
            if [ -d "../backups" ]; then
              echo "ğŸ§¹ æ¸…ç†æ—§å¤‡ä»½..."
              cd ../backups
              ls -t | tail -n +6 | xargs rm -rf 2>/dev/null || true
            fi
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
          EOF
      
      - name: Health check
        run: |
          # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
          sleep 10
          
          # å¥åº·æ£€æŸ¥ï¼ˆè¯·æ ¹æ®å®é™…å¥åº·æ£€æŸ¥ç«¯ç‚¹ä¿®æ”¹ï¼‰
          HEALTH_URL="http://${{ env.SERVER_HOST }}/health"
          if curl -f "$HEALTH_URL" > /dev/null 2>&1; then
            echo "âœ… å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸  å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—"
            exit 1
          fi

