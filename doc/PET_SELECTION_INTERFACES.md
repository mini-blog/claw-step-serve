# å® ç‰©é€‰æ‹©æ¥å£å®ç°æ–‡æ¡£

## ğŸ“‹ æ¥å£æ€»è§ˆ

æ ¹æ®å® ç‰©é€‰æ‹©æµç¨‹éœ€æ±‚ï¼Œå·²å®ç°ä»¥ä¸‹åç«¯æ¥å£ï¼š

### 1. å® ç‰©ç›¸å…³æ¥å£

#### 1.1 è·å–å® ç‰©åˆ—è¡¨
- **GET /api/pet**
  - åŠŸèƒ½ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„å® ç‰©åˆ—è¡¨
  - è®¤è¯ï¼šæ— éœ€è®¤è¯
  - è¿”å›ï¼šå® ç‰©åˆ—è¡¨ï¼ˆid, name, englishName, description, imageUrl, personalityï¼‰

#### 1.2 è·å–å® ç‰©è¯¦æƒ…
- **GET /api/pet/:id**
  - åŠŸèƒ½ï¼šæ ¹æ®IDè·å–å® ç‰©è¯¦ç»†ä¿¡æ¯
  - è®¤è¯ï¼šæ— éœ€è®¤è¯
  - è¿”å›ï¼šå® ç‰©è¯¦æƒ…

#### 1.3 è·å–ç”¨æˆ·å½“å‰æ¿€æ´»çš„å® ç‰©
- **GET /api/pet/user/active**
  - åŠŸèƒ½ï¼šè·å–å½“å‰ç”¨æˆ·æ­£åœ¨ä½¿ç”¨çš„å® ç‰©
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¿”å›ï¼šç”¨æˆ·å® ç‰©å…³ç³»ï¼ˆåŒ…å«å® ç‰©ä¿¡æ¯ï¼‰

#### 1.4 è·å–ç”¨æˆ·çš„æ‰€æœ‰å® ç‰©
- **GET /api/pet/user/all**
  - åŠŸèƒ½ï¼šè·å–ç”¨æˆ·é€‰æ‹©è¿‡çš„æ‰€æœ‰å® ç‰©åˆ—è¡¨
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¿”å›ï¼šç”¨æˆ·å® ç‰©åˆ—è¡¨

---

### 2. åŸå¸‚ç›¸å…³æ¥å£

#### 2.1 è·å–åŸå¸‚åˆ—è¡¨
- **GET /api/city**
  - åŠŸèƒ½ï¼šè·å–æ‰€æœ‰å¯ç”¨çš„åŸå¸‚åˆ—è¡¨
  - è®¤è¯ï¼šæ— éœ€è®¤è¯
  - æŸ¥è¯¢å‚æ•°ï¼š
    - `continent`ï¼ˆå¯é€‰ï¼‰ï¼šæŒ‰å¤§æ´²ç­›é€‰ï¼Œå¦‚ï¼šAsia, Europe
    - `isUnlocked`ï¼ˆå¯é€‰ï¼‰ï¼šæŒ‰è§£é”çŠ¶æ€ç­›é€‰ï¼Œtrue/false
  - è¿”å›ï¼šåŸå¸‚åˆ—è¡¨ï¼ˆid, name, englishName, continent, country, imageUrl, isUnlockedï¼‰

#### 2.2 è·å–åŸå¸‚è¯¦æƒ…
- **GET /api/city/:id**
  - åŠŸèƒ½ï¼šæ ¹æ®IDè·å–åŸå¸‚è¯¦ç»†ä¿¡æ¯
  - è®¤è¯ï¼šæ— éœ€è®¤è¯
  - è¿”å›ï¼šåŸå¸‚è¯¦æƒ…

#### 2.3 è·å–ç”¨æˆ·å½“å‰è®¿é—®çš„åŸå¸‚
- **GET /api/city/user/current**
  - åŠŸèƒ½ï¼šè·å–å½“å‰ç”¨æˆ·æœ€è¿‘è®¿é—®çš„åŸå¸‚
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¿”å›ï¼šç”¨æˆ·åŸå¸‚å…³ç³»ï¼ˆåŒ…å«åŸå¸‚ä¿¡æ¯ï¼‰

#### 2.4 è·å–ç”¨æˆ·çš„æ‰€æœ‰åŸå¸‚
- **GET /api/city/user/all**
  - åŠŸèƒ½ï¼šè·å–ç”¨æˆ·è®¿é—®è¿‡çš„æ‰€æœ‰åŸå¸‚åˆ—è¡¨
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¿”å›ï¼šç”¨æˆ·åŸå¸‚åˆ—è¡¨

---

### 3. ç”¨æˆ·åˆå§‹åŒ–ä¸åˆ‡æ¢æ¥å£

#### 3.1 å®Œæˆåˆå§‹åŒ–æµç¨‹ â­æ ¸å¿ƒæ¥å£
- **POST /api/user/onboarding/complete**
  - åŠŸèƒ½ï¼šç”¨æˆ·é¦–æ¬¡ç™»å½•åï¼Œå®Œæˆå® ç‰©å’ŒåŸå¸‚çš„é€‰æ‹©ï¼Œä»¥åŠç”¨æˆ·æ˜µç§°çš„è®¾ç½®
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¯·æ±‚ä½“ï¼š
    ```json
    {
      "petId": "uuid-string",        // å¿…éœ€
      "cityId": "uuid-string",       // å¿…éœ€
      "nickname": "ç”¨æˆ·æ˜µç§°",         // å¯é€‰
      "initialSteps": 0              // å¯é€‰ï¼Œé»˜è®¤0
    }
    ```
  - è¿”å›ï¼š
    ```json
    {
      "user": { ... },               // æ›´æ–°åçš„ç”¨æˆ·ä¿¡æ¯
      "userPet": {                   // ç”¨æˆ·å® ç‰©å…³ç³»
        "id": "...",
        "userId": "...",
        "petId": "...",
        "isActive": true,
        "selectedAt": "...",
        "pet": { ... }               // å® ç‰©è¯¦ç»†ä¿¡æ¯
      },
      "userCity": {                 // ç”¨æˆ·åŸå¸‚å…³ç³»
        "id": "...",
        "userId": "...",
        "cityId": "...",
        "visitCount": 1,
        "totalSteps": 0,
        "totalCalories": 0,
        "firstVisitAt": "...",
        "lastVisitAt": "...",
        "city": { ... }              // åŸå¸‚è¯¦ç»†ä¿¡æ¯
      }
    }
    ```
  - é€»è¾‘ï¼š
    1. æ›´æ–°ç”¨æˆ·æ˜µç§°ï¼ˆå¦‚æœæä¾›ï¼‰
    2. é€‰æ‹©å® ç‰©ï¼šå°†æ—§å® ç‰©è®¾ä¸º`isActive=false`ï¼Œæ–°å® ç‰©è®¾ä¸º`isActive=true`
    3. é€‰æ‹©åŸå¸‚ï¼šå¦‚æœé¦–æ¬¡è®¿é—®åˆ™åˆ›å»ºè®°å½•ï¼Œå¦åˆ™æ›´æ–°è®¿é—®ä¿¡æ¯

#### 3.2 åˆ‡æ¢å® ç‰©
- **POST /api/user/pet/switch**
  - åŠŸèƒ½ï¼šç”¨æˆ·åˆ‡æ¢å½“å‰ä½¿ç”¨çš„å® ç‰©
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¯·æ±‚ä½“ï¼š
    ```json
    {
      "petId": "uuid-string"        // å¿…éœ€
    }
    ```
  - è¿”å›ï¼šæ›´æ–°åçš„ç”¨æˆ·å® ç‰©å…³ç³»
  - é€»è¾‘ï¼š
    1. å°†æ‰€æœ‰è¯¥ç”¨æˆ·çš„å® ç‰©è®¾ä¸º`isActive=false`
    2. æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥å® ç‰©è®°å½•ï¼Œå­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º
    3. å°†æ–°å® ç‰©è®¾ä¸º`isActive=true`

#### 3.3 åˆ‡æ¢åŸå¸‚
- **POST /api/user/city/switch**
  - åŠŸèƒ½ï¼šç”¨æˆ·åˆ‡æ¢å½“å‰è®¿é—®çš„åŸå¸‚
  - è®¤è¯ï¼šéœ€è¦JWTè®¤è¯
  - è¯·æ±‚ä½“ï¼š
    ```json
    {
      "cityId": "uuid-string"        // å¿…éœ€
    }
    ```
  - è¿”å›ï¼šæ›´æ–°åçš„ç”¨æˆ·åŸå¸‚å…³ç³»
  - é€»è¾‘ï¼š
    1. æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¯¥åŸå¸‚è®°å½•
    2. å¦‚æœå­˜åœ¨ï¼š`visitCount++`ï¼Œ`lastVisitAt=now()`
    3. å¦‚æœä¸å­˜åœ¨ï¼šåˆ›å»ºæ–°è®°å½•ï¼Œ`visitCount=1`ï¼Œ`firstVisitAt=now()`ï¼Œ`lastVisitAt=now()`

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡è¯´æ˜

### åˆ†è¡¨è®¾è®¡

é‡‡ç”¨åˆ†è¡¨è®¾è®¡ï¼ˆUserPet + UserCityï¼‰ï¼Œè€Œéåˆå¹¶è¡¨ï¼š

#### ä¼˜åŠ¿
1. **èŒè´£åˆ†ç¦»**ï¼šå® ç‰©å…³ç³»å…³æ³¨æ¿€æ´»çŠ¶æ€ï¼ŒåŸå¸‚å…³ç³»å…³æ³¨è®¿é—®ç»Ÿè®¡
2. **æŸ¥è¯¢ç‹¬ç«‹**ï¼šå¤§å¤šæ•°åœºæ™¯åªæŸ¥è¯¢å…¶ä¸­ä¸€ä¸ªè¡¨
3. **æ‰©å±•æ€§å¥½**ï¼šæœªæ¥å­—æ®µå˜æ›´å½±å“èŒƒå›´å°
4. **ç´¢å¼•ç²¾å‡†**ï¼šæ¯ä¸ªè¡¨å¯ä»¥é’ˆå¯¹ä¸åŒæŸ¥è¯¢åœºæ™¯ä¼˜åŒ–ç´¢å¼•

### UserPet è¡¨ç­–ç•¥

- **isActiveå­—æ®µ**ï¼šæ ‡è¯†å½“å‰æ¿€æ´»çš„å® ç‰©
- **selectedAtå­—æ®µ**ï¼šè®°å½•é€‰æ‹©æ—¶é—´ï¼Œæ”¯æŒå†å²è¿½è¸ª
- **æ›´æ–°ç­–ç•¥**ï¼š
  - åˆ‡æ¢å® ç‰©æ—¶ï¼Œå°†æ‰€æœ‰å® ç‰©è®¾ä¸º`isActive=false`
  - æ–°é€‰æ‹©çš„å® ç‰©è®¾ä¸º`isActive=true`
  - ä¿ç•™å†å²è®°å½•ï¼Œä¾¿äºç”¨æˆ·æŸ¥çœ‹é€‰æ‹©è¿‡çš„å® ç‰©

### UserCity è¡¨ç­–ç•¥

- **visitCountå­—æ®µ**ï¼šè®°å½•è®¿é—®æ¬¡æ•°
- **lastVisitAtå­—æ®µ**ï¼šè®°å½•æœ€åè®¿é—®æ—¶é—´ï¼Œç”¨äºè·å–å½“å‰åŸå¸‚
- **æ›´æ–°ç­–ç•¥**ï¼š
  - é¦–æ¬¡è®¿é—®ï¼šåˆ›å»ºè®°å½•ï¼Œ`visitCount=1`
  - å†æ¬¡è®¿é—®ï¼š`visitCount++`ï¼Œæ›´æ–°`lastVisitAt`
  - æŸ¥è¯¢å½“å‰åŸå¸‚ï¼šæŒ‰`lastVisitAt DESC`æ’åºå–ç¬¬ä¸€æ¡

---

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### äº‹åŠ¡å¤„ç†

æ‰€æœ‰æ¶‰åŠå¤šè¡¨æ“ä½œçš„æ–¹æ³•éƒ½ä½¿ç”¨Prismaäº‹åŠ¡ï¼ˆ`$transaction`ï¼‰ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

```typescript
await this.prisma.$transaction(async (tx) => {
  // å¤šä¸ªæ“ä½œ
});
```

### JWTè®¤è¯

æ‰€æœ‰éœ€è¦ç”¨æˆ·èº«ä»½çš„æ“ä½œéƒ½ä½¿ç”¨JWTè®¤è¯ï¼š
- JWT payloadä¸­åŒ…å«ç”¨æˆ·IDï¼š`{ id: string }`
- é€šè¿‡`@ApiBearerAuth('JWT-auth')`æ ‡è®°éœ€è¦è®¤è¯
- ä»`request.user.id`è·å–ç”¨æˆ·ID

### è·¯ç”±é¡ºåº

æ³¨æ„è·¯ç”±é¡ºåºï¼Œç¡®ä¿å…·ä½“è·¯ç”±åœ¨å‚æ•°è·¯ç”±ä¹‹å‰ï¼š
- âœ… `GET /pet/user/active` åœ¨ `GET /pet/:id` ä¹‹å‰
- âœ… `GET /city/user/current` åœ¨ `GET /city/:id` ä¹‹å‰

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åˆå§‹åŒ–æµç¨‹

```bash
# 1. è·å–å® ç‰©åˆ—è¡¨
GET /api/pet
Authorization: Bearer <token>

# 2. è·å–åŸå¸‚åˆ—è¡¨
GET /api/city
Authorization: Bearer <token>

# 3. å®Œæˆåˆå§‹åŒ–
POST /api/user/onboarding/complete
Authorization: Bearer <token>
Content-Type: application/json

{
  "petId": "pet-uuid-123",
  "cityId": "city-uuid-456",
  "nickname": "å°æ˜",
  "initialSteps": 1000
}
```

### åˆ‡æ¢å® ç‰©

```bash
POST /api/user/pet/switch
Authorization: Bearer <token>
Content-Type: application/json

{
  "petId": "new-pet-uuid"
}
```

### åˆ‡æ¢åŸå¸‚

```bash
POST /api/user/city/switch
Authorization: Bearer <token>
Content-Type: application/json

{
  "cityId": "new-city-uuid"
}
```

---

## âœ… å·²å®Œæˆçš„å·¥ä½œ

1. âœ… åˆ›å»ºPetæ¨¡å—ï¼ˆservice, controller, module, DTOsï¼‰
2. âœ… åˆ›å»ºCityæ¨¡å—ï¼ˆservice, controller, module, DTOsï¼‰
3. âœ… åœ¨UserServiceä¸­æ·»åŠ onboardingå’Œåˆ‡æ¢æ–¹æ³•
4. âœ… åœ¨UserControllerä¸­æ·»åŠ onboardingå’Œåˆ‡æ¢ç«¯ç‚¹
5. âœ… æ³¨å†Œæ–°æ¨¡å—åˆ°AppModule
6. âœ… ä¿®å¤è·¯ç”±é¡ºåºé—®é¢˜
7. âœ… æ‰€æœ‰ä»£ç é€šè¿‡lintæ£€æŸ¥

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
src/modules/
â”œâ”€â”€ pet/
â”‚   â”œâ”€â”€ pet.controller.ts
â”‚   â”œâ”€â”€ pet.service.ts
â”‚   â”œâ”€â”€ pet.module.ts
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ pet-response.dto.ts
â”œâ”€â”€ city/
â”‚   â”œâ”€â”€ city.controller.ts
â”‚   â”œâ”€â”€ city.service.ts
â”‚   â”œâ”€â”€ city.module.ts
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ city-response.dto.ts
â””â”€â”€ user/
    â”œâ”€â”€ user.controller.ts (å·²æ›´æ–°)
    â”œâ”€â”€ user.service.ts (å·²æ›´æ–°)
    â””â”€â”€ dto/
        â””â”€â”€ onboarding.dto.ts (æ–°å¢)
```

---

## ğŸš€ ä¸‹ä¸€æ­¥

æ¥å£å·²å…¨éƒ¨å®ç°ï¼Œå¯ä»¥ï¼š
1. å¯åŠ¨æœåŠ¡è¿›è¡Œæµ‹è¯•
2. åœ¨Swagger UIä¸­æŸ¥çœ‹æ¥å£æ–‡æ¡£ï¼ˆ`http://localhost:3000/docs`ï¼‰
3. å‰ç«¯å¯¹æ¥è¿™äº›æ¥å£å®Œæˆå® ç‰©é€‰æ‹©æµç¨‹

