# 来信功能开发计划

## 位置说明
计划文件位于：`/Users/Zhuanz/work/app/claw_step_serve/来信功能开发计划.md`

## 已完成的工作

### 1. 数据库设计 ✅
- ✅ 更新了 Prisma schema，添加了以下模型：
  - `LetterTemplate` - 来信模板表
  - `Letter` - 扩展了原有模型，添加了以下字段：
    - `templateId` - 关联的模板ID
    - `mediaUrls` - 媒体文件URLs数组
    - `mediaType` - 媒体类型
    - `hasInteracted` - 是否已交互
    - `interactionType` - 交互类型
    - `readAt` - 阅读时间
    - `interactedAt` - 交互时间
  - `LetterReply` - 来信回复表

### 2. 后端接口实现 ✅
已创建完整的 letter 模块，包含以下文件：
- `letter.module.ts` - 模块定义
- `letter.controller.ts` - 控制器（7个接口）
- `letter.service.ts` - 业务逻辑服务
- `dto/letter.dto.ts` - 请求DTO
- `dto/letter-response.dto.ts` - 响应DTO

### 3. 实现的接口列表 ✅

#### 3.1 GET /api/letter
- **功能**: 获取用户的来信列表
- **查询参数**: 
  - `type` (可选) - 来信类型筛选
  - `isRead` (可选) - 是否已读筛选
- **响应**: 包含来信列表和未读数量

#### 3.2 GET /api/letter/:id
- **功能**: 获取来信的完整内容和回复历史
- **响应**: 包含来信详情和所有回复

#### 3.3 PUT /api/letter/:id/read
- **功能**: 标记来信为已读
- **响应**: 返回更新后的状态

#### 3.4 POST /api/letter/:id/reply
- **功能**: 用户回复来信（试一下或保存）
- **请求体**:
  - `action`: "try" | "save"
  - `content`: 用户回复文本（可选）
  - `mediaUrls`: 用户上传的图片URLs（可选）
  - `extraData`: 额外数据（根据type不同有不同字段）
- **响应**: 返回用户回复和AI回复（如果action为"try"）

#### 3.5 GET /api/letter/:id/reply/:replyId
- **功能**: 获取AI回复的生成状态和结果
- **响应**: 返回AI回复的详细状态

#### 3.6 GET /api/letter/unread-count
- **功能**: 获取未读来信数量
- **响应**: 返回未读数量

#### 3.7 POST /api/letter/push
- **功能**: 推送来信（内部接口，可选）
- **说明**: 当前为简化实现，需要根据实际业务逻辑完善

### 4. 模块注册 ✅
- ✅ 已在 `app.module.ts` 中注册 `LetterModule`

## 待完成的工作

### 1. 数据库迁移 ⚠️
需要运行数据库迁移以更新数据库结构：

```bash
cd /Users/Zhuanz/work/app/claw_step_serve
npx prisma migrate dev --name add_letter_system
```

**注意**: 由于现有 `Letter` 表已经存在，但字段不同，需要：
1. 迁移现有的 `mediaUrl` 数据到 `mediaUrls` 数组
2. 添加新字段（`templateId`, `mediaUrls`, `mediaType`, `hasInteracted`, `interactionType`, `readAt`, `interactedAt`）
3. 创建新表（`letter_templates`, `letter_replies`）

### 2. AI服务集成 ⚠️
当前 `letter.service.ts` 中的 `processAiGeneration` 方法为模拟实现，需要：
- 集成实际的AI绘画API
- 集成实际的AI歌曲生成API
- 集成实际的AI星盘生成API
- 处理异步任务和错误处理
- 考虑使用队列系统（如Bull）来处理AI生成任务

### 3. 推送逻辑完善 ⚠️
`pushLetter` 方法当前为简化实现，需要：
- 实现触发条件检查（城市、步数、天数等）
- 实现模板匹配逻辑
- 实现批量推送功能
- 集成推送通知服务

### 4. 数据迁移脚本（如果需要）⚠️
如果需要保留现有的 `Letter` 数据，需要编写迁移脚本：
- 将 `mediaUrl` 转换为 `mediaUrls` 数组
- 设置默认值（`mediaType`, `hasInteracted` 等）

### 5. 前端对接 🔄
前端代码位于 `claw_step_application/lib/pages/home/widgets/`，需要：
- 将 `letter_tab.dart` 中的模拟数据替换为API调用
- 更新 `letter_detail_page.dart` 以对接后端接口
- 处理API错误和加载状态
- 实现图片上传功能（如果需要）

## 技术要点

### 数据库设计
- 使用 PostgreSQL 数组类型存储 `mediaUrls`
- 使用关联关系管理模板、来信和回复
- 支持软删除和级联删除

### API设计
- 遵循RESTful风格
- 使用JWT认证保护接口
- 完整的Swagger文档注解
- 统一的响应格式

### 业务逻辑
- 支持三种来信类型：aiDrawing, aiSong, aiHoroscope
- 支持两种交互方式：try（试一下）和 save（保存）
- AI生成是异步处理
- 支持查询AI生成状态

## 测试建议

1. **单元测试**: 为 `LetterService` 编写单元测试
2. **集成测试**: 测试完整的API流程
3. **数据库测试**: 验证迁移脚本的正确性
4. **AI服务测试**: 测试AI生成的各种场景

## 部署注意事项

1. 确保数据库迁移在部署前完成
2. 配置AI服务的API密钥
3. 配置云存储（如果需要存储用户上传的图片）
4. 配置推送通知服务（如果需要实时推送）

## 下一步行动

1. ⚠️ **立即执行**: 运行数据库迁移（需要先启动数据库）
2. ⚠️ **高优先级**: 集成实际的AI服务API
3. ⚠️ **中优先级**: 完善推送逻辑
4. 🔄 **中优先级**: 前端对接
5. ⚠️ **低优先级**: 编写测试用例

---

**创建时间**: 2025年
**文件位置**: `/Users/Zhuanz/work/app/claw_step_serve/来信功能开发计划.md`
