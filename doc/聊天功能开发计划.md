# 聊天功能开发计划

## 位置说明
计划文件位于：`/Users/Zhuanz/work/app/claw_step_serve/聊天功能开发计划.md`

## 已完成的工作

### 1. 数据库设计 ✅

#### 1.1 新增 ChatSession 表
- 每个用户和宠物只有一个活跃会话（通过 `@@unique([userId, petId])` 约束）
- 字段包括：
  - `startTime` / `endTime` - 会话时间
  - `duration` - 会话时长（秒）
  - `messageCount` / `userMessageCount` / `petMessageCount` - 消息统计
  - `isActive` - 是否活跃

#### 1.2 扩展 ChatMessage 表
- 新增字段：
  - `sessionId` - 关联的聊天会话ID
  - `mediaUrls` - 媒体文件URLs数组（支持多个媒体）
  - `mediaType` - 媒体类型（'none' | 'image' | 'voice' | 'imageText'）
  - `duration` - 语音时长（秒）
- 保留原有字段：`type`, `content`, `isFromUser`, `createdAt`

### 2. 后端接口实现 ✅

已创建完整的 chat 模块，包含以下文件：
- `chat.module.ts` - 模块定义
- `chat.controller.ts` - 控制器（8个接口）
- `chat.service.ts` - 业务逻辑服务
- `services/doubao.service.ts` - 豆包API服务（预留接口）
- `dto/chat.dto.ts` - 请求DTO
- `dto/chat-response.dto.ts` - 响应DTO

### 3. 实现的接口列表 ✅

#### 3.1 POST /api/chat/session
- **功能**: 创建或获取聊天会话
- **说明**: 每个用户和宠物只有一个活跃会话，如果存在则返回，不存在则创建
- **请求体**: `{ petId: string }`
- **响应**: `{ sessionId, startTime, petId }`

#### 3.2 GET /api/chat/session/current
- **功能**: 获取当前活跃会话
- **查询参数**: `petId` (必需)
- **响应**: `ChatSessionDto | null`

#### 3.3 POST /api/chat/message/text
- **功能**: 发送文字消息并获取AI回复
- **请求体**: `{ sessionId?, petId, content }`
- **响应**: `{ userMessage, petMessage, sessionId }`

#### 3.4 POST /api/chat/message/image
- **功能**: 发送图片消息（支持图片+文字）并获取AI回复
- **请求体**: `{ sessionId?, petId, imageUrl, content? }`
- **响应**: `{ userMessage, petMessage, sessionId }`

#### 3.5 POST /api/chat/message/voice
- **功能**: 发送语音消息并获取AI语音回复
- **请求体**: `{ sessionId?, petId, voiceUrl, duration }`
- **响应**: `{ userMessage, petMessage, sessionId, petVoiceUrl? }`

#### 3.6 GET /api/chat/messages
- **功能**: 获取聊天消息历史
- **查询参数**: `petId` (必需), `limit?`, `offset?`
- **响应**: `{ messages, total, sessionId? }`

#### 3.7 PUT /api/chat/session/:id/end
- **功能**: 结束聊天会话
- **响应**: `{ sessionId, duration, messageCount }`

#### 3.8 GET /api/chat/sessions
- **功能**: 获取用户的会话列表
- **查询参数**: `limit?`, `offset?`
- **响应**: `{ sessions, total }`

### 4. 豆包API服务 ✅

已创建 `DoubaoService`，包含以下方法（预留接口）：
- `chatText()` - 文本对话
- `chatImage()` - 图片理解对话
- `speechToText()` - 语音转文字
- `textToSpeech()` - 文字转语音

**注意**: 当前为模拟实现，需要配置实际的豆包API密钥并实现调用逻辑。

### 5. 模块注册 ✅
- ✅ 已在 `app.module.ts` 中注册 `ChatModule`

## 核心业务逻辑

### 会话管理
- **唯一性**: 通过数据库唯一约束 `@@unique([userId, petId])` 确保每个用户和宠物只有一个会话
- **自动创建**: 发送消息时如果会话不存在会自动创建
- **自动激活**: 如果会话已存在但不活跃，会自动重新激活

### 消息处理流程
1. 用户发送消息 → 创建用户消息记录
2. 更新会话统计（消息数、用户消息数）
3. 获取对话上下文（最近10条消息）
4. 调用豆包API获取AI回复
5. 创建宠物回复消息记录
6. 更新会话统计（宠物消息数）

### 对话上下文
- 自动维护最近10条消息作为上下文
- 上下文格式：`[{ role: 'user' | 'assistant', content: string }]`
- 用于AI回复时保持对话连贯性

## 待完成的工作

### 1. 数据库迁移 ⚠️
需要运行数据库迁移以更新数据库结构：

```bash
cd /Users/Zhuanz/work/app/claw_step_serve
npx prisma migrate dev --name add_chat_system
```

**注意**: 由于现有 `ChatMessage` 表已经存在，需要：
1. 迁移现有的 `mediaUrl` 数据到 `mediaUrls` 数组
2. 添加新字段（`sessionId`, `mediaUrls`, `mediaType`, `duration`）
3. 创建新表（`chat_sessions`）

### 2. 豆包API集成 ⚠️
当前 `DoubaoService` 为模拟实现，需要：
1. 配置豆包API密钥（环境变量：`DOUBAO_API_KEY`, `DOUBAO_BASE_URL`）
2. 实现实际的HTTP请求调用
3. 处理API错误和重试逻辑
4. 实现流式响应（如果需要）

**参考文档**: 
- 豆包API文档: https://www.volcengine.com/docs/82379
- 需要申请API密钥和配置模型端点

### 3. 文件上传服务 ⚠️
当前接口需要图片和语音的URL，需要：
1. 实现文件上传接口（图片、语音）
2. 集成云存储（OSS/S3）
3. 处理文件大小和格式限制
4. 返回文件URL

### 4. 实时推送（可选）⚠️
如果需要实时推送AI回复，可以考虑：
1. 使用WebSocket推送AI回复
2. 使用消息队列（如Bull）处理异步AI生成
3. 前端轮询获取AI回复状态

### 5. 前端对接 🔄
前端代码位于 `claw_step_application/lib/pages/home/widgets/`，需要：
- 将 `voice_chat_page.dart` 中的模拟数据替换为API调用
- 实现文件上传功能
- 处理API错误和加载状态
- 实现消息轮询或WebSocket连接

## 技术要点

### 数据库设计
- 使用 PostgreSQL 数组类型存储 `mediaUrls`
- 使用唯一约束确保每个用户和宠物只有一个会话
- 支持会话历史记录和统计

### API设计
- 遵循RESTful风格
- 使用JWT认证保护接口
- 完整的Swagger文档注解
- 统一的响应格式

### 业务逻辑
- 支持三种消息类型：文字、图片、语音
- 自动维护对话上下文
- 根据宠物性格调整AI回复
- 支持会话统计和时长记录

## 环境变量配置

需要在 `.env` 文件中添加：

```env
# 豆包API配置
DOUBAO_API_KEY=your_api_key_here
DOUBAO_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
```

## 测试建议

1. **单元测试**: 为 `ChatService` 编写单元测试
2. **集成测试**: 测试完整的API流程
3. **数据库测试**: 验证迁移脚本的正确性
4. **AI服务测试**: 测试豆包API的各种场景

## 部署注意事项

1. 确保数据库迁移在部署前完成
2. 配置豆包API密钥
3. 配置文件上传服务（云存储）
4. 配置消息队列（如果需要异步处理）

## 下一步行动

1. ⚠️ **立即执行**: 运行数据库迁移（需要先启动数据库）
2. ⚠️ **高优先级**: 集成豆包API（配置API密钥并实现调用）
3. ⚠️ **高优先级**: 实现文件上传接口
4. 🔄 **中优先级**: 前端对接
5. ⚠️ **低优先级**: 实现WebSocket实时推送

---

**创建时间**: 2025年
**文件位置**: `/Users/Zhuanz/work/app/claw_step_serve/聊天功能开发计划.md`
